<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Wiss Cards</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet"/>
<script src="/socket.io/socket.io.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg:#0f0f1a;
  --table:#1a2a1a;
  --felt:#1e3a1e;
  --card-h:120px;
  --card-w:80px;
}
body{
  background:var(--bg);
  font-family:'DM Sans',sans-serif;
  color:#f0f0f0;
  min-height:100vh;
  overflow:hidden;
  user-select:none;
}

/* ===== OVERLAY ===== */
#overlay{
  position:fixed;inset:0;
  background:linear-gradient(135deg,#0f0f1a 0%,#1a0a2e 100%);
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;gap:16px;z-index:200;
}
.logo{
  font-family:'Bebas Neue',sans-serif;
  font-size:5rem;letter-spacing:6px;
  background:linear-gradient(135deg,#ff6b6b,#ffd93d,#6bcb77,#4d96ff);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  text-shadow:none;filter:drop-shadow(0 0 30px #ff6b6b60);
}
.sub{color:#555;font-size:.85rem;letter-spacing:3px;text-transform:uppercase;margin-top:-12px;}

.panel{background:#13131f;border:1px solid #2a2a3e;border-radius:16px;padding:24px;width:320px;}
.panel-title{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:2px;color:#ffd93d;margin-bottom:16px;}

input{
  width:100%;background:#0f0f1a;border:1px solid #2a2a3e;border-radius:8px;
  padding:12px 16px;color:#f0f0f0;font-family:'DM Sans',sans-serif;font-size:.95rem;
  outline:none;margin-bottom:10px;transition:border-color .2s;
}
input:focus{border-color:#ffd93d;}
input::placeholder{color:#444;}

.btn{
  width:100%;padding:13px;border:none;border-radius:8px;cursor:pointer;
  font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;
  transition:all .2s;margin-bottom:6px;
}
.btn-primary{background:linear-gradient(135deg,#ff6b6b,#ffd93d);color:#0f0f1a;}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px #ff6b6b40;}
.btn-ghost{background:transparent;color:#555;border:1px solid #2a2a3e;}
.btn-ghost:hover{border-color:#ffd93d;color:#ffd93d;}
.err{color:#ff6b6b;font-size:.8rem;text-align:center;min-height:16px;}

/* ===== LOBBY ===== */
#lobby-screen{
  position:fixed;inset:0;background:var(--bg);
  display:none;align-items:center;justify-content:center;flex-direction:column;gap:20px;z-index:150;
}
.lobby-code{
  font-family:'Bebas Neue',sans-serif;font-size:4rem;letter-spacing:12px;
  color:#ffd93d;text-shadow:0 0 30px #ffd93d60;
  border:2px dashed #ffd93d40;border-radius:12px;padding:16px 32px;
}
.players-list{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;max-width:500px;}
.player-chip{
  padding:8px 16px;border-radius:20px;font-size:.9rem;font-weight:600;
  border:2px solid currentColor;
}
.host-badge{font-size:.7rem;opacity:.7;margin-left:4px;}

/* ===== GAME ===== */
#game-screen{
  position:fixed;inset:0;display:none;
  flex-direction:column;align-items:center;justify-content:center;
}

/* Table */
.table-wrap{
  position:relative;width:min(700px,95vw);
  display:flex;flex-direction:column;align-items:center;
  gap:0;
}

.table{
  width:min(600px,90vw);height:min(340px,45vw);
  background:radial-gradient(ellipse at center, #2a4a2a 0%, #1a3a1a 60%, #0f2a0f 100%);
  border-radius:50%;
  border:4px solid #2e5a2e;
  box-shadow:0 0 60px #00000080, inset 0 0 40px #00000040, 0 0 0 8px #1a2a1a;
  position:relative;
  display:flex;align-items:center;justify-content:center;
}

/* Center area */
.center-area{
  display:flex;gap:20px;align-items:center;
}

/* Deck */
.deck-pile{
  width:var(--card-w);height:var(--card-h);
  background:linear-gradient(135deg,#1a237e,#283593);
  border-radius:10px;border:2px solid #3949ab;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-family:'Bebas Neue',sans-serif;font-size:.8rem;letter-spacing:1px;color:#7986cb;
  position:relative;transition:transform .15s;
  box-shadow:3px 3px 0 #0d1757, 6px 6px 0 #0a1244;
}
.deck-pile:hover{transform:scale(1.05);}
.deck-count{
  position:absolute;top:-10px;right:-10px;
  background:#ffd93d;color:#0f0f1a;
  border-radius:20px;padding:2px 8px;font-size:.75rem;font-weight:700;
}

/* Discard */
.discard-pile{
  width:var(--card-w);height:var(--card-h);
  border-radius:10px;border:2px solid #ffffff20;
  display:flex;align-items:center;justify-content:center;
  background:#00000030;
}

/* Opponent seats ‚Äî positioned around table */
.seat{
  position:absolute;
  display:flex;flex-direction:column;align-items:center;gap:4px;
}
.seat-name{
  font-size:.75rem;font-weight:600;padding:3px 10px;
  border-radius:20px;border:1.5px solid currentColor;
  white-space:nowrap;
}
.seat-cards{
  display:flex;gap:-6px;
}
.opp-card{
  width:32px;height:46px;
  background:linear-gradient(135deg,#1a237e,#283593);
  border-radius:5px;border:1px solid #3949ab;
  margin-left:-6px;
  box-shadow:1px 1px 3px #00000060;
  transition:transform .15s;
}
.opp-card:first-child{margin-left:0;}

.turn-glow{
  box-shadow:0 0 0 3px #ffd93d, 0 0 20px #ffd93d80 !important;
}

/* My hand */
.my-hand{
  display:flex;justify-content:center;
  padding:12px 0 8px;
  overflow-x:auto;
  max-width:100vw;
}

/* Card */
.card{
  width:var(--card-w);height:var(--card-h);
  border-radius:10px;
  display:flex;flex-direction:column;align-items:center;justify-content:space-between;
  padding:8px;cursor:pointer;
  position:relative;flex-shrink:0;
  transition:transform .15s, box-shadow .15s;
  margin-left:-24px;border:2px solid #ffffff20;
  box-shadow:0 4px 15px #00000060;
}
.card:first-child{margin-left:0;}
.card:hover{transform:translateY(-20px) scale(1.05);z-index:10;box-shadow:0 12px 30px #00000080;}
.card.playable{border-color:#ffd93d !important;}
.card.playable:hover{box-shadow:0 12px 30px #ffd93d60;}
.card.not-playable{opacity:.5;cursor:not-allowed;}
.card .val{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;line-height:1;color:#fff;text-shadow:0 1px 3px #00000060;}
.card .val.small{font-size:1rem;}
.card .center-val{font-family:'Bebas Neue',sans-serif;font-size:2.5rem;color:rgba(255,255,255,.3);}
.card .effect-icon{font-size:1.6rem;}
.card .corner{display:flex;flex-direction:column;align-items:center;gap:1px;}
.card .corner.br{transform:rotate(180deg);}

/* Colors */
.c-red{background:linear-gradient(135deg,#c0392b,#e74c3c);}
.c-blue{background:linear-gradient(135deg,#1a5276,#2980b9);}
.c-green{background:linear-gradient(135deg,#1e8449,#27ae60);}
.c-yellow{background:linear-gradient(135deg,#b7950b,#f1c40f);color:#0f0f1a;}
.c-purple{background:linear-gradient(135deg,#6c3483,#9b59b6);}
.c-wild{background:linear-gradient(135deg,#ff6b6b,#ffd93d,#6bcb77,#4d96ff);}

/* HUD */
#hud{
  position:fixed;top:12px;left:12px;right:12px;
  display:flex;justify-content:space-between;align-items:flex-start;
  pointer-events:none;z-index:50;
}
.hud-left,.hud-right{pointer-events:all;}
.turn-banner{
  background:#ffd93d;color:#0f0f1a;
  font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;
  padding:6px 16px;border-radius:20px;
  animation:pulse .8s ease-in-out infinite alternate;
  pointer-events:all;
}
@keyframes pulse{from{box-shadow:0 0 10px #ffd93d60;}to{box-shadow:0 0 25px #ffd93d;}};

/* Log */
#log{
  position:fixed;left:12px;bottom:160px;
  display:flex;flex-direction:column;gap:4px;
  pointer-events:none;z-index:50;
}
.log-entry{
  background:#13131fdd;border:1px solid #2a2a3e;
  border-radius:6px;padding:4px 10px;font-size:.75rem;color:#aaa;
  animation:slideIn .3s ease;
}
@keyframes slideIn{from{opacity:0;transform:translateX(-10px);}to{opacity:1;transform:translateX(0);}}

/* Chat */
#chat-wrap{
  position:fixed;right:12px;bottom:160px;width:220px;
  display:flex;flex-direction:column;gap:4px;z-index:50;
}
#chat-msgs{
  display:flex;flex-direction:column;gap:3px;
  max-height:150px;overflow-y:auto;
}
.chat-msg{
  background:#13131fdd;border-radius:6px;padding:4px 8px;font-size:.75rem;
}
.chat-msg .cn{font-weight:700;}
#chat-input-wrap{display:flex;gap:4px;}
#chat-input{
  flex:1;background:#13131f;border:1px solid #2a2a3e;border-radius:6px;
  padding:6px 10px;color:#f0f0f0;font-size:.8rem;outline:none;
}
#chat-send{
  background:#ffd93d;color:#0f0f1a;border:none;border-radius:6px;
  padding:6px 10px;font-family:'Bebas Neue',sans-serif;cursor:pointer;font-size:.9rem;
}

/* Color picker modal */
#color-picker{
  position:fixed;inset:0;background:#00000090;
  display:none;align-items:center;justify-content:center;z-index:100;
}
.color-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:24px;}
.color-opt{
  width:80px;height:80px;border-radius:12px;cursor:pointer;border:3px solid transparent;
  transition:all .15s;display:flex;align-items:center;justify-content:center;
  font-size:1.5rem;
}
.color-opt:hover{transform:scale(1.1);border-color:#fff;}

/* Spy modal */
#spy-modal{
  position:fixed;inset:0;background:#00000090;
  display:none;align-items:center;justify-content:center;z-index:100;flex-direction:column;gap:12px;
}
.spy-panel{background:#13131f;border:1px solid #2a2a3e;border-radius:12px;padding:16px;min-width:200px;}
.spy-title{font-family:'Bebas Neue',sans-serif;color:#6bcb77;margin-bottom:8px;letter-spacing:2px;}

/* Vote modal */
#vote-modal{
  position:fixed;inset:0;background:#00000090;
  display:none;align-items:center;justify-content:center;z-index:100;
}
.vote-panel{background:#13131f;border:1px solid #ffd93d40;border-radius:16px;padding:24px;min-width:300px;}
.vote-title{font-family:'Bebas Neue',sans-serif;color:#ffd93d;font-size:1.3rem;letter-spacing:2px;margin-bottom:16px;}
.vote-opt{
  width:100%;padding:10px 16px;margin-bottom:8px;background:#0f0f1a;border:1px solid #2a2a3e;
  border-radius:8px;color:#f0f0f0;cursor:pointer;text-align:left;font-family:'DM Sans',sans-serif;
  transition:all .15s;
}
.vote-opt:hover{border-color:#ffd93d;color:#ffd93d;}

/* Round over modal */
#round-modal{
  position:fixed;inset:0;background:#00000090;
  display:none;align-items:center;justify-content:center;z-index:100;
}
.round-panel{
  background:linear-gradient(135deg,#13131f,#1a1a2e);
  border:1px solid #ffd93d40;border-radius:16px;padding:32px;min-width:300px;text-align:center;
}
.round-title{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:3px;color:#ffd93d;margin-bottom:4px;}
.round-winner{font-size:1.1rem;color:#6bcb77;margin-bottom:20px;}
.scores{display:flex;flex-direction:column;gap:8px;margin-bottom:20px;}
.score-row{display:flex;justify-content:space-between;align-items:center;padding:6px 12px;background:#0f0f1a;border-radius:8px;}
.score-name{font-weight:600;}
.score-pts{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;color:#ffd93d;}

/* Bomb warning */
#bomb-warn{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  font-family:'Bebas Neue',sans-serif;font-size:3rem;letter-spacing:4px;
  color:#ff6b6b;text-shadow:0 0 30px #ff6b6b;
  pointer-events:none;display:none;z-index:80;
  animation:bombPulse .5s ease-in-out infinite alternate;
}
@keyframes bombPulse{from{opacity:.5;transform:translate(-50%,-50%) scale(.95);}to{opacity:1;transform:translate(-50%,-50%) scale(1.05);}}

/* Notif */
.notif{
  position:fixed;top:60px;left:50%;transform:translateX(-50%);
  background:#ffd93d;color:#0f0f1a;
  font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;
  padding:10px 24px;border-radius:20px;z-index:150;
  animation:notifAnim 2.5s forwards;
}
@keyframes notifAnim{0%{opacity:0;top:40px;}10%{opacity:1;top:60px;}80%{opacity:1;}100%{opacity:0;top:40px;}}
</style>
</head>
<body>

<!-- OVERLAY HOME -->
<div id="overlay">
  <div class="logo">WISS CARDS</div>
  <div class="sub">Le jeu de cartes de vos potes</div>
  <div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;">
    <div class="panel">
      <div class="panel-title">Cr√©er</div>
      <input id="create-name" placeholder="Ton pseudo" maxlength="12"/>
      <button class="btn btn-primary" id="btn-create">Cr√©er un lobby</button>
    </div>
    <div class="panel">
      <div class="panel-title">Rejoindre</div>
      <input id="join-name" placeholder="Ton pseudo" maxlength="12"/>
      <input id="join-code" placeholder="Code du lobby" maxlength="5" style="text-transform:uppercase;letter-spacing:4px;text-align:center;"/>
      <button class="btn btn-primary" id="btn-join">Rejoindre</button>
    </div>
  </div>
  <div class="err" id="home-err"></div>
</div>

<!-- LOBBY -->
<div id="lobby-screen">
  <div style="text-align:center;margin-bottom:8px;color:#555;font-size:.85rem;letter-spacing:2px;text-transform:uppercase;">Code du lobby</div>
  <div class="lobby-code" id="lobby-code-display">XXXXX</div>
  <div class="players-list" id="lobby-players"></div>
  <div id="lobby-host-section" style="display:none;margin-top:8px;">
    <button class="btn btn-primary" id="btn-start" style="width:200px;">Lancer la partie</button>
    <div style="color:#555;font-size:.8rem;text-align:center;margin-top:6px;">Min. 2 joueurs</div>
  </div>
  <div id="lobby-wait" style="color:#555;font-size:.85rem;">En attente du host...</div>
  <div class="err" id="lobby-err"></div>
</div>

<!-- GAME -->
<div id="game-screen">
  <div id="hud">
    <div class="hud-left">
      <div id="turn-banner" class="turn-banner" style="display:none;">TON TOUR !</div>
    </div>
    <div class="hud-right">
      <div id="host-btns" style="display:none;">
        <button class="btn btn-ghost" id="btn-new-round" style="width:auto;padding:6px 14px;font-size:.9rem;">Nouvelle manche</button>
      </div>
    </div>
  </div>

  <div class="table-wrap" id="table-wrap">
    <div class="table" id="table">
      <div class="center-area">
        <div class="deck-pile" id="deck-btn">
          <div class="deck-count" id="deck-count">52</div>
          üÇ†<br/>PIOCHER
        </div>
        <div class="discard-pile" id="discard-pile"></div>
      </div>
    </div>
  </div>

  <div class="my-hand" id="my-hand"></div>

  <div id="log"></div>
  <div id="chat-wrap">
    <div id="chat-msgs"></div>
    <div id="chat-input-wrap">
      <input id="chat-input" placeholder="Message..." maxlength="80"/>
      <button id="chat-send">‚Üí</button>
    </div>
  </div>
</div>

<!-- MODALS -->
<div id="color-picker">
  <div style="background:#13131f;border:1px solid #2a2a3e;border-radius:16px;padding:24px;text-align:center;">
    <div style="font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:2px;margin-bottom:16px;color:#ffd93d;">Choisir une couleur</div>
    <div class="color-grid">
      <div class="color-opt c-red" data-color="red">üî¥</div>
      <div class="color-opt c-blue" data-color="blue">üîµ</div>
      <div class="color-opt c-green" data-color="green">üü¢</div>
      <div class="color-opt c-yellow" data-color="yellow">üü°</div>
    </div>
  </div>
</div>

<div id="spy-modal">
  <div style="font-family:'Bebas Neue',sans-serif;font-size:1.5rem;color:#6bcb77;letter-spacing:3px;margin-bottom:12px;">üëÅÔ∏è ESPIONNAGE</div>
  <div id="spy-content" style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;"></div>
  <button class="btn btn-ghost" id="spy-close" style="width:150px;margin-top:12px;">Fermer</button>
</div>

<div id="vote-modal">
  <div class="vote-panel">
    <div class="vote-title">üó≥Ô∏è VOTE COLLECTIF</div>
    <div id="vote-options"></div>
    <div id="vote-status" style="color:#555;font-size:.8rem;text-align:center;margin-top:8px;"></div>
  </div>
</div>

<div id="round-modal">
  <div class="round-panel">
    <div class="round-title">MANCHE TERMIN√âE</div>
    <div class="round-winner" id="round-winner"></div>
    <div class="scores" id="round-scores"></div>
    <div id="round-host-btn" style="display:none;">
      <button class="btn btn-primary" id="btn-next-round">Manche suivante</button>
    </div>
    <div id="round-wait" style="color:#555;font-size:.8rem;">En attente du host...</div>
  </div>
</div>

<div id="bomb-warn">üí£ BOMBE !</div>

<script>
const socket = io();

let myId = null;
let myCode = null;
let isHost = false;
let pendingCard = null;
let myTurn = false;
let gameState = null;
let hasVoted = false;

// ===== HOME =====
document.getElementById('btn-create').addEventListener('click', () => {
  const name = document.getElementById('create-name').value.trim() || 'Host';
  socket.emit('create_lobby', { name });
});

document.getElementById('btn-join').addEventListener('click', () => {
  const name = document.getElementById('join-name').value.trim() || 'Joueur';
  const code = document.getElementById('join-code').value.trim().toUpperCase();
  if (!code) return showErr('home-err', 'Entre un code !');
  socket.emit('join_lobby', { name, code });
});

// ===== SOCKET =====
socket.on('joined', ({ code }) => {
  myCode = code;
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('lobby-screen').style.display = 'flex';
});

socket.on('game_started', () => {
  document.getElementById('lobby-screen').style.display = 'none';
  document.getElementById('game-screen').style.display = 'flex';
});

socket.on('lobby_state', (data) => {
  myCode = data.code;
  isHost = data.isHost;
  document.getElementById('lobby-code-display').textContent = data.code;
  const list = document.getElementById('lobby-players');
  list.innerHTML = '';
  data.players.forEach(p => {
    const chip = document.createElement('div');
    chip.className = 'player-chip';
    chip.style.color = p.color;
    chip.style.borderColor = p.color;
    chip.textContent = p.name + (p.isHost ? ' üëë' : '');
    list.appendChild(chip);
  });
  document.getElementById('lobby-host-section').style.display = isHost ? 'block' : 'none';
  document.getElementById('lobby-wait').style.display = isHost ? 'none' : 'block';
  if (data.gameStarted) {
    document.getElementById('lobby-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'flex';
  }
});

socket.on('game_state', (state) => {
  gameState = state;
  myId = socket.id;
  myTurn = state.currentPlayer === myId;
  renderGame(state);
});

socket.on('error', ({ msg }) => {
  showErr('home-err', msg);
  showErr('lobby-err', msg);
  notif(msg, '#ff6b6b');
});

socket.on('chat_msg', ({ name, color, msg }) => {
  const msgs = document.getElementById('chat-msgs');
  const el = document.createElement('div');
  el.className = 'chat-msg';
  el.innerHTML = `<span class="cn" style="color:${color}">${name}:</span> ${escHtml(msg)}`;
  msgs.appendChild(el);
  msgs.scrollTop = msgs.scrollHeight;
});

socket.on('spy_reveal', ({ hands }) => {
  const modal = document.getElementById('spy-modal');
  const content = document.getElementById('spy-content');
  content.innerHTML = '';
  hands.forEach(p => {
    const panel = document.createElement('div');
    panel.className = 'spy-panel';
    panel.innerHTML = `<div class="spy-title">${p.name}</div>`;
    const cards = document.createElement('div');
    cards.style.cssText = 'display:flex;flex-wrap:wrap;gap:4px;';
    p.hand.forEach(c => {
      const el = renderCardEl(c, false);
      el.style.cssText = `width:50px;height:70px;font-size:.8rem;cursor:default;margin:0;`;
      cards.appendChild(el);
    });
    panel.appendChild(cards);
    content.appendChild(panel);
  });
  modal.style.display = 'flex';
});

document.getElementById('spy-close').addEventListener('click', () => {
  document.getElementById('spy-modal').style.display = 'none';
});

socket.on('round_over', ({ winner, scores }) => {
  document.getElementById('round-winner').textContent = `üèÜ ${winner} remporte la manche !`;
  const sc = document.getElementById('round-scores');
  sc.innerHTML = '';
  scores.sort((a,b) => b.score - a.score).forEach(s => {
    const row = document.createElement('div');
    row.className = 'score-row';
    row.innerHTML = `<span class="score-name" style="color:${s.color}">${s.name}</span><span class="score-pts">${s.score} pts</span>`;
    sc.appendChild(row);
  });
  document.getElementById('round-host-btn').style.display = isHost ? 'block' : 'none';
  document.getElementById('round-wait').style.display = isHost ? 'none' : 'block';
  document.getElementById('round-modal').style.display = 'flex';
});

// ===== ACTIONS =====
document.getElementById('btn-start').addEventListener('click', () => {
  socket.emit('start_game', { code: myCode });
});

document.getElementById('deck-btn').addEventListener('click', () => {
  if (!myTurn) return;
  socket.emit('draw_card', { code: myCode });
});

document.getElementById('btn-new-round').addEventListener('click', () => {
  socket.emit('new_round', { code: myCode });
});

document.getElementById('btn-next-round').addEventListener('click', () => {
  document.getElementById('round-modal').style.display = 'none';
  socket.emit('new_round', { code: myCode });
});

// Color picker
document.querySelectorAll('.color-opt').forEach(opt => {
  opt.addEventListener('click', () => {
    const color = opt.dataset.color;
    document.getElementById('color-picker').style.display = 'none';
    socket.emit('play_card', { code: myCode, cardId: pendingCard.id, chosenColor: color });
    pendingCard = null;
  });
});

// Chat
document.getElementById('chat-send').addEventListener('click', sendChat);
document.getElementById('chat-input').addEventListener('keydown', e => { if (e.key === 'Enter') sendChat(); });
function sendChat() {
  const msg = document.getElementById('chat-input').value.trim();
  if (!msg) return;
  socket.emit('chat', { code: myCode, msg });
  document.getElementById('chat-input').value = '';
}

// ===== RENDER =====
function renderGame(state) {
  // HUD
  document.getElementById('turn-banner').style.display = myTurn ? 'block' : 'none';
  document.getElementById('host-btns').style.display = isHost ? 'block' : 'none';
  document.getElementById('deck-count').textContent = state.deckCount;

  // Bomb
  const bombWarn = document.getElementById('bomb-warn');
  if (state.bombActive && state.bombTarget === myId) {
    bombWarn.style.display = 'block';
  } else {
    bombWarn.style.display = 'none';
  }

  // Top card
  const discard = document.getElementById('discard-pile');
  discard.innerHTML = '';
  if (state.topCard) {
    const el = renderCardEl(state.topCard, false);
    el.style.cursor = 'default';
    el.style.margin = '0';
    el.style.transform = `rotate(${(Math.random()-0.5)*10}deg)`;
    discard.appendChild(el);
  }

  // Opponents around table
  renderSeats(state);

  // My hand
  const hand = document.getElementById('my-hand');
  hand.innerHTML = '';
  state.hand.forEach(card => {
    const playable = myTurn && !state.voteOptions && canPlay(card, state.topCard, state.pendingEffect);
    const el = renderCardEl(card, true);
    el.classList.toggle('playable', playable);
    el.classList.toggle('not-playable', !playable);
    if (playable) {
      el.addEventListener('click', () => {
        if (card.type === 'wild') {
          pendingCard = card;
          document.getElementById('color-picker').style.display = 'flex';
        } else {
          socket.emit('play_card', { code: myCode, cardId: card.id });
        }
      });
    }
    hand.appendChild(el);
  });

  // Log
  const logEl = document.getElementById('log');
  logEl.innerHTML = '';
  state.log.forEach(msg => {
    const el = document.createElement('div');
    el.className = 'log-entry';
    el.textContent = msg;
    logEl.appendChild(el);
  });

  // Vote
  if (state.voteOptions && !hasVoted) {
    const modal = document.getElementById('vote-modal');
    const opts = document.getElementById('vote-options');
    opts.innerHTML = '';
    state.voteOptions.forEach(opt => {
      const btn = document.createElement('button');
      btn.className = 'vote-opt';
      btn.textContent = opt;
      btn.addEventListener('click', () => {
        socket.emit('vote_choice', { code: myCode, choice: opt });
        hasVoted = true;
        document.getElementById('vote-status').textContent = 'Vote envoy√© !';
        opts.querySelectorAll('button').forEach(b => b.disabled = true);
      });
      opts.appendChild(btn);
    });
    modal.style.display = 'flex';
  } else if (!state.voteOptions) {
    document.getElementById('vote-modal').style.display = 'none';
    hasVoted = false;
  }
}

function renderSeats(state) {
  // Remove old seats
  document.querySelectorAll('.seat').forEach(s => s.remove());

  const table = document.getElementById('table');
  const tw = table.offsetWidth;
  const th = table.offsetHeight;

  const opponents = state.players.filter(p => p.id !== myId);
  const count = opponents.length;
  if (count === 0) return;

  // Position around top arc of ellipse
  opponents.forEach((p, i) => {
    const seat = document.createElement('div');
    seat.className = 'seat';

    // Angle: spread from -60 to 60 degrees on top of ellipse
    const angle = count === 1 ? Math.PI/2 : Math.PI/2 + (i - (count-1)/2) * (Math.PI / (count+1));
    const rx = tw * 0.45;
    const ry = th * 0.45;
    const cx = tw / 2 + rx * Math.cos(Math.PI - angle);
    const cy = th / 2 - ry * Math.sin(angle) * 0.6;

    seat.style.cssText = `left:${cx}px;top:${cy}px;transform:translate(-50%,-50%);`;

    if (p.isCurrentTurn) seat.style.filter = 'drop-shadow(0 0 8px #ffd93d)';

    const name = document.createElement('div');
    name.className = 'seat-name';
    name.style.color = p.color;
    name.style.borderColor = p.color;
    name.textContent = p.name + (p.shielded ? ' üõ°Ô∏è' : '');

    const cards = document.createElement('div');
    cards.className = 'seat-cards';
    const showCount = Math.min(p.cardCount, 8);
    for (let i = 0; i < showCount; i++) {
      const c = document.createElement('div');
      c.className = 'opp-card';
      if (p.isCurrentTurn) c.style.borderColor = '#ffd93d';
      cards.appendChild(c);
    }

    const score = document.createElement('div');
    score.style.cssText = `font-size:.7rem;color:#555;`;
    score.textContent = `${p.cardCount} cartes ‚Ä¢ ${p.score} pts`;

    seat.appendChild(name);
    seat.appendChild(cards);
    seat.appendChild(score);
    table.appendChild(seat);
  });
}

function renderCardEl(card, interactive) {
  const el = document.createElement('div');
  el.className = `card c-${card.color}`;
  if (!interactive) el.style.pointerEvents = 'none';

  const topVal = cardDisplay(card);
  const botVal = cardDisplay(card);

  if (card.type === 'number') {
    el.innerHTML = `
      <div class="corner">${topVal}</div>
      <div class="center-val">${card.value}</div>
      <div class="corner br">${botVal}</div>`;
  } else {
    el.innerHTML = `
      <div class="corner"><div class="val small">${effectShort(card.effect)}</div></div>
      <div class="effect-icon">${effectIcon(card.effect)}</div>
      <div class="corner br"><div class="val small">${effectShort(card.effect)}</div></div>`;
  }

  return el;
}

function cardDisplay(card) {
  if (card.type === 'number') return `<div class="val">${card.value}</div>`;
  return `<div class="val small">${effectShort(card.effect)}</div>`;
}

function effectShort(e) {
  const m = {skip:'‚è≠',reverse:'üîÑ',draw2:'+2',draw4:'+4',steal:'ü¶ä',mirror:'ü™û',chaos:'üé∞',spy:'üëÅ',bomb:'üí£',swap_hands:'üîÄ',vote:'üó≥',shield:'üõ°'};
  return m[e] || e;
}

function effectIcon(e) {
  const m = {skip:'‚è≠Ô∏è',reverse:'üîÑ',draw2:'‚úåÔ∏è',draw4:'üñêÔ∏è',steal:'ü¶ä',mirror:'ü™û',chaos:'üé∞',spy:'üëÅÔ∏è',bomb:'üí£',swap_hands:'üîÄ',vote:'üó≥Ô∏è',shield:'üõ°Ô∏è'};
  return m[e] || '‚ùì';
}

function canPlay(card, topCard, pendingEffect) {
  if (!topCard) return true;
  if (card.type === 'wild') return true;
  if (gameState && gameState.pendingEffect) return false;
  const tc = (gameState && gameState.topCard && gameState.topCard.chosenColor) || topCard.color;
  if (card.color === tc) return true;
  if (card.type === 'number' && topCard.type === 'number' && card.value === topCard.value) return true;
  if (card.type === 'special' && topCard.type === 'special' && card.effect === topCard.effect) return true;
  return false;
}

function showErr(id, msg) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  setTimeout(() => { el.textContent = ''; }, 3000);
}

function notif(msg, color = '#ffd93d') {
  const el = document.createElement('div');
  el.className = 'notif';
  el.style.background = color;
  el.style.color = color === '#ffd93d' ? '#0f0f1a' : '#fff';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2500);
}

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
