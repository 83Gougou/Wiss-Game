<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wiss Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0a0a0f; font-family: 'DM Sans', sans-serif; color: #f0f0f0; overflow: hidden; }

    #overlay {
      position: fixed; inset: 0;
      background: #0a0a0f;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 20px;
      z-index: 100;
    }

    .logo { font-family: 'Bebas Neue', sans-serif; font-size: 5rem; color: #e8ff47; letter-spacing: 4px; text-shadow: 0 0 40px #e8ff4760; }
    .sub { color: #555; font-size: .9rem; letter-spacing: 2px; text-transform: uppercase; margin-top: -16px; }

    input[type="text"] {
      background: #13131a; border: 1px solid #1e1e2e; border-radius: 10px;
      padding: 14px 20px; color: #f0f0f0; font-size: 1rem; font-family: 'DM Sans', sans-serif;
      outline: none; width: 280px; text-align: center;
      transition: border-color .2s;
    }
    input[type="text"]:focus { border-color: #e8ff47; }

    .btn {
      background: #e8ff47; color: #0a0a0f;
      border: none; border-radius: 10px; padding: 14px 40px;
      font-family: 'Bebas Neue', sans-serif; font-size: 1.2rem; letter-spacing: 3px;
      cursor: pointer; transition: all .2s; width: 280px;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 30px #e8ff4740; }

    #game-wrap { position: relative; width: 100vw; height: 100vh; display: none; }
    canvas { display: block; }

    #hud {
      position: fixed; top: 16px; left: 16px;
      background: #13131a; border: 1px solid #1e1e2e;
      border-radius: 12px; padding: 12px 16px;
      min-width: 160px;
      pointer-events: none;
    }

    .hud-title { font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 2px; color: #e8ff47; margin-bottom: 8px; }

    .hp-bar { height: 8px; background: #1e1e2e; border-radius: 4px; margin-bottom: 10px; overflow: hidden; }
    .hp-fill { height: 100%; background: #2ed573; border-radius: 4px; transition: width .3s; }

    .inv-row { display: flex; align-items: center; gap: 8px; font-size: .85rem; margin-bottom: 4px; }
    .inv-icon { font-size: 1rem; }
    .inv-val { color: #e8ff47; font-weight: 600; }

    #controls {
      position: fixed; bottom: 16px; right: 16px;
      background: #13131a; border: 1px solid #1e1e2e;
      border-radius: 12px; padding: 12px 16px;
      font-size: .75rem; color: #555;
      pointer-events: none;
    }
    #controls div { margin-bottom: 3px; }
    #controls span { color: #e8ff47; }

    #kill-feed {
      position: fixed; top: 16px; right: 16px;
      display: flex; flex-direction: column; gap: 6px;
      pointer-events: none;
    }

    .kill-msg {
      background: #13131a; border: 1px solid #1e1e2e;
      border-radius: 8px; padding: 6px 12px;
      font-size: .8rem; color: #f0f0f0;
      animation: fadeOut 3s forwards;
    }

    @keyframes fadeOut {
      0% { opacity: 1; } 70% { opacity: 1; } 100% { opacity: 0; }
    }

    #flash {
      position: fixed; inset: 0;
      background: #ff475720;
      pointer-events: none;
      opacity: 0;
      transition: opacity .1s;
    }
    #flash.show { opacity: 1; }

    #minimap {
      position: fixed; bottom: 16px; left: 16px;
      border: 1px solid #1e1e2e; border-radius: 8px;
      overflow: hidden;
    }
  </style>
</head>
<body>

<div id="overlay">
  <div class="logo">WISS</div>
  <div class="sub">Roguelike Multijoueur</div>
  <input type="text" id="name-input" placeholder="Ton pseudo" maxlength="12"/>
  <button class="btn" id="btn-play">JOUER</button>
</div>

<div id="game-wrap">
  <canvas id="game"></canvas>
  <canvas id="minimap" width="150" height="150"></canvas>

  <div id="hud">
    <div class="hud-title" id="hud-name">Joueur</div>
    <div class="hp-bar"><div class="hp-fill" id="hp-fill"></div></div>
    <div class="inv-row"><span class="inv-icon">ðŸŒ²</span> Bois <span class="inv-val" id="inv-wood">0</span></div>
    <div class="inv-row"><span class="inv-icon">ðŸª¨</span> Pierre <span class="inv-val" id="inv-stone">0</span></div>
    <div class="inv-row"><span class="inv-icon">âœ¨</span> Or <span class="inv-val" id="inv-gold">0</span></div>
  </div>

  <div id="controls">
    <div><span>ZQSD / FlÃ¨ches</span> â€” Bouger</div>
    <div><span>Espace / Clic</span> â€” Attaquer</div>
  </div>

  <div id="kill-feed"></div>
  <div id="flash"></div>
</div>

<script>
const socket = io();

const overlay = document.getElementById('overlay');
const gameWrap = document.getElementById('game-wrap');
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const miniCanvas = document.getElementById('minimap');
const miniCtx = miniCanvas.getContext('2d');

let myId = null;
let MAP = { w: 2400, h: 2400 };
let players = [];
let resources = [];
let cam = { x: 0, y: 0 };
let myInv = { wood: 0, stone: 0, gold: 0 };
let myHp = 100;
let myName = 'Player';

const keys = { up: false, down: false, left: false, right: false };

// Input
window.addEventListener('keydown', e => {
  if (e.key === 'z' || e.key === 'ArrowUp')    { keys.up = true; send(); }
  if (e.key === 's' || e.key === 'ArrowDown')  { keys.down = true; send(); }
  if (e.key === 'q' || e.key === 'ArrowLeft')  { keys.left = true; send(); }
  if (e.key === 'd' || e.key === 'ArrowRight') { keys.right = true; send(); }
  if (e.key === ' ') { e.preventDefault(); socket.emit('attack'); }
});

window.addEventListener('keyup', e => {
  if (e.key === 'z' || e.key === 'ArrowUp')    { keys.up = false; send(); }
  if (e.key === 's' || e.key === 'ArrowDown')  { keys.down = false; send(); }
  if (e.key === 'q' || e.key === 'ArrowLeft')  { keys.left = false; send(); }
  if (e.key === 'd' || e.key === 'ArrowRight') { keys.right = false; send(); }
});

canvas.addEventListener('click', () => socket.emit('attack'));

function send() { socket.emit('keys', { ...keys }); }

// Start
document.getElementById('btn-play').addEventListener('click', () => {
  const name = document.getElementById('name-input').value.trim() || 'Anonyme';
  myName = name;
  socket.emit('set_name', name);
  overlay.style.display = 'none';
  gameWrap.style.display = 'block';
  resize();
});

// Resize
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);

// Socket
socket.on('init', (data) => {
  myId = data.id;
  MAP = data.map;
  resources = data.resources;
});

socket.on('game_state', (state) => {
  players = state;
  const me = players.find(p => p.id === myId);
  if (me) {
    cam.x = me.x - canvas.width / 2;
    cam.y = me.y - canvas.height / 2;
    cam.x = Math.max(0, Math.min(MAP.w - canvas.width, cam.x));
    cam.y = Math.max(0, Math.min(MAP.h - canvas.height, cam.y));
    myHp = me.hp;
    updateHud(me);
  }
});

socket.on('resource_update', (data) => {
  const r = resources.find(r => r.id === data.id);
  if (r) { r.alive = data.alive; if (data.x) { r.x = data.x; r.y = data.y; } }
});

socket.on('harvested', (data) => {
  myInv = data.inv;
  document.getElementById('inv-wood').textContent = myInv.wood;
  document.getElementById('inv-stone').textContent = myInv.stone;
  document.getElementById('inv-gold').textContent = myInv.gold;
});

socket.on('hit', (data) => {
  myHp = data.hp;
  const flash = document.getElementById('flash');
  flash.classList.add('show');
  setTimeout(() => flash.classList.remove('show'), 150);
});

socket.on('died', () => {
  myInv = { wood: 0, stone: 0, gold: 0 };
  document.getElementById('inv-wood').textContent = 0;
  document.getElementById('inv-stone').textContent = 0;
  document.getElementById('inv-gold').textContent = 0;
  addKillMsg('ðŸ’€ Tu es mort et tu as perdu tes ressources !');
});

function updateHud(me) {
  document.getElementById('hud-name').textContent = me.name;
  document.getElementById('hp-fill').style.width = (me.hp / me.maxHp * 100) + '%';
  document.getElementById('hp-fill').style.background = me.hp > 50 ? '#2ed573' : me.hp > 25 ? '#fb923c' : '#ff4757';
}

function addKillMsg(msg) {
  const feed = document.getElementById('kill-feed');
  const el = document.createElement('div');
  el.className = 'kill-msg';
  el.textContent = msg;
  feed.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// Resource visuals
const RES_STYLE = {
  wood:  { color: '#2d4a22', accent: '#4ade80', icon: 'ðŸŒ²', label: 'Bois' },
  stone: { color: '#3a3a3a', accent: '#94a3b8', icon: 'ðŸª¨', label: 'Pierre' },
  gold:  { color: '#5a4000', accent: '#fbbf24', icon: 'âœ¨', label: 'Or' },
};

// Draw
function draw() {
  requestAnimationFrame(draw);
  if (!myId) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Background grid
  ctx.fillStyle = '#0d0d14';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  ctx.strokeStyle = '#1a1a28';
  ctx.lineWidth = 1;
  const gridSize = 80;
  const startX = -cam.x % gridSize;
  const startY = -cam.y % gridSize;
  for (let x = startX; x < canvas.width; x += gridSize) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
  }
  for (let y = startY; y < canvas.height; y += gridSize) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
  }
  ctx.restore();

  ctx.save();
  ctx.translate(-cam.x, -cam.y);

  // Map border
  ctx.strokeStyle = '#e8ff4730';
  ctx.lineWidth = 3;
  ctx.strokeRect(0, 0, MAP.w, MAP.h);

  // Resources
  resources.forEach(r => {
    if (!r.alive) return;
    const style = RES_STYLE[r.type];
    const s = 16;

    ctx.save();
    ctx.translate(r.x, r.y);

    // Shadow
    ctx.fillStyle = '#00000040';
    ctx.beginPath();
    ctx.ellipse(0, s + 4, s * 0.8, 4, 0, 0, Math.PI * 2);
    ctx.fill();

    // Body
    ctx.fillStyle = style.color;
    ctx.beginPath();
    if (r.type === 'wood') {
      // Tree trunk
      ctx.fillRect(-4, -4, 8, 20);
      ctx.fillStyle = style.accent;
      ctx.beginPath();
      ctx.arc(0, -10, 16, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = '#1a3a10';
      ctx.beginPath();
      ctx.arc(-4, -14, 8, 0, Math.PI * 2);
      ctx.fill();
    } else if (r.type === 'stone') {
      ctx.beginPath();
      ctx.ellipse(0, 0, s, s * 0.7, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = style.accent;
      ctx.beginPath();
      ctx.ellipse(-4, -4, s * 0.5, s * 0.35, -0.3, 0, Math.PI * 2);
      ctx.fill();
    } else {
      // Gold crystal
      ctx.fillStyle = style.accent;
      ctx.beginPath();
      ctx.moveTo(0, -s); ctx.lineTo(s * 0.6, 0); ctx.lineTo(0, s * 0.8); ctx.lineTo(-s * 0.6, 0);
      ctx.closePath(); ctx.fill();
      ctx.fillStyle = '#fef08a';
      ctx.beginPath();
      ctx.moveTo(0, -s); ctx.lineTo(s * 0.3, -s * 0.2); ctx.lineTo(0, 0); ctx.lineTo(-s * 0.3, -s * 0.2);
      ctx.closePath(); ctx.fill();
    }

    ctx.restore();
  });

  // Players
  players.forEach(p => {
    const isMe = p.id === myId;
    const x = p.x, y = p.y;
    const size = 20;

    ctx.save();
    ctx.translate(x, y);

    // Attack ring
    if (p.attacking) {
      ctx.strokeStyle = p.color + '80';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(0, 0, 50, 0, Math.PI * 2);
      ctx.stroke();
    }

    // Shadow
    ctx.fillStyle = '#00000050';
    ctx.beginPath();
    ctx.ellipse(0, size + 4, size * 0.8, 5, 0, 0, Math.PI * 2);
    ctx.fill();

    // Body glow (me)
    if (isMe) {
      ctx.shadowColor = p.color;
      ctx.shadowBlur = 15;
    }

    // Body
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.roundRect(-size, -size, size * 2, size * 2, 5);
    ctx.fill();

    ctx.shadowBlur = 0;

    // Eyes
    ctx.fillStyle = '#0a0a0f';
    ctx.fillRect(-7, -7, 5, 5);
    ctx.fillRect(2, -7, 5, 5);

    // HP bar
    const hpW = 44;
    ctx.fillStyle = '#1e1e2e';
    ctx.fillRect(-hpW/2, -size - 14, hpW, 6);
    const hpPct = p.hp / p.maxHp;
    ctx.fillStyle = hpPct > 0.5 ? '#2ed573' : hpPct > 0.25 ? '#fb923c' : '#ff4757';
    ctx.fillRect(-hpW/2, -size - 14, hpW * hpPct, 6);

    // Name
    ctx.fillStyle = isMe ? p.color : '#ffffff';
    ctx.font = `${isMe ? '700' : '500'} 11px DM Sans`;
    ctx.textAlign = 'center';
    ctx.fillText(p.name, 0, -size - 18);

    ctx.restore();
  });

  ctx.restore();

  // Minimap
  drawMinimap();
}

function drawMinimap() {
  const mw = 150, mh = 150;
  const scaleX = mw / MAP.w, scaleY = mh / MAP.h;

  miniCtx.fillStyle = '#0d0d14';
  miniCtx.fillRect(0, 0, mw, mh);

  resources.forEach(r => {
    if (!r.alive) return;
    const style = RES_STYLE[r.type];
    miniCtx.fillStyle = style.accent;
    miniCtx.fillRect(r.x * scaleX - 1, r.y * scaleY - 1, 2, 2);
  });

  players.forEach(p => {
    miniCtx.fillStyle = p.id === myId ? '#ffffff' : p.color;
    miniCtx.beginPath();
    miniCtx.arc(p.x * scaleX, p.y * scaleY, p.id === myId ? 3 : 2, 0, Math.PI * 2);
    miniCtx.fill();
  });

  // Camera rect
  const me = players.find(p => p.id === myId);
  if (me) {
    miniCtx.strokeStyle = '#e8ff4760';
    miniCtx.lineWidth = 1;
    miniCtx.strokeRect(
      cam.x * scaleX, cam.y * scaleY,
      canvas.width * scaleX, canvas.height * scaleY
    );
  }
}

draw();
</script>
</body>
</html>
